<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Data Detective RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Data Detective Atom Feed"><title data-react-helmet="true">DAG testing | Data Detective</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://data-detective.dev/docs/data-detective-airflow/testing"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="DAG testing | Data Detective"><meta data-react-helmet="true" name="description" content="Our team set a goal to achieve convenient testing of datasets in pipelines."><meta data-react-helmet="true" property="og:description" content="Our team set a goal to achieve convenient testing of datasets in pipelines."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://data-detective.dev/docs/data-detective-airflow/testing"><link data-react-helmet="true" rel="alternate" href="https://data-detective.dev/docs/data-detective-airflow/testing" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://data-detective.dev/docs/data-detective-airflow/testing" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.93f58ce6.css">
<link rel="preload" href="/assets/js/runtime~main.da2280e1.js" as="script">
<link rel="preload" href="/assets/js/main.ab52783e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-tinkoff.svg" alt="data-detective logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo-tinkoff.svg" alt="data-detective logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Data Detective</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link navbar__link--active" href="/docs/welcome">Docs</a><a href="https://github.com/tinkoff/data-detective" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/welcome">Welcome page</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/data-catalogs-overview">OpenSource Data Catalog projects overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Data Detective Project</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Data Detective Airflow</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/data-detective-airflow/intro">Data Detective Airflow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/data-detective-airflow/quickstart-airflow">Quickstart</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Tutorial</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/data-detective-airflow/testing">DAG testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/data-detective-airflow/production">Production</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/data-detective-airflow/comparison">Comparison with other frameworks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/data-detective-airflow/datasets-abstractions">Abstractions for datasets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/data-detective-airflow/how-to-release">How to release data-detective-airflow</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Data Detective Airflow API reference</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Data Detective ETL</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>DAG testing</h1></header><p>Our team set a goal to achieve convenient testing of datasets in pipelines.</p><p>To achieve the goal , it is necessary</p><ul><li>save datasets in a readable format</li><li>regenerate datasets</li><li>configure test environments, prepare input data</li></ul><p>We have developed a solution that saves datasets in the form of JSON.
<code>pandas.DataFrame.to_json</code> allows saving json to a file in a readable form.
Each json element is saved in a new line. When modifying DAGs, the developer regenerates json, and git shows readable diff. This allows the developer to evaluate changes by the task.</p><p>DAGs in data-detective-airflow consist of operators. Operators take input data from external sources or works.
The TBaseOperator defines the read_result method for reading the final dataset. Usually the operator saves the data in work.
PgSCD1 modifies the data in the target table. For testing, data is needed from the target, and not from the temporary table in pg-work,
so the read_result method is redefined in PgSCD1.</p><p>It is important to prepare an external environment as similar as possible to a grocery one. docker-compose allows you to organize such an environment.
It is possible to initialize databases and raise a web server that will respond in a similar way and use mockups from pytest-mock.</p><p>Let&#x27;s take a closer look at the example of a dummy DAG:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI python"><pre tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">dag_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;dummy&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> generate_dag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dag_dir</span><span class="token operator" style="color:#393A34">=</span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">settings</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">DAGS_FOLDER</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">/dags/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">dag_name</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dataset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> JSONPandasDataset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">settings</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">AIRFLOW_HOME</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">/tests_data/dags/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">dag_name</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gen_dataset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> is_gen_dataset_mode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@pytest</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">mark</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">skipif</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">condition</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">gen_dataset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reason</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;Gen dataset&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@pytest</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">mark</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">parametrize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;task&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">test_task</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mocker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> setup_tables</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run_and_assert_task</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dataset</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">dataset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mocker</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">mocker</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@pytest</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">mark</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">skipif</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">condition</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> gen_dataset</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reason</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;Gen dataset&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:#393A34">@pytest</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">mark</span><span class="token decorator annotation punctuation" style="color:#393A34">.</span><span class="token decorator annotation punctuation" style="color:#393A34">parametrize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;task&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tasks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">test_gen_tests_data</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mocker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> setup_tables</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    run_and_gen_ds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">settings</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">AIRFLOW_HOME</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">/tests_data/dags/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">dag_name</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>JSONPandasDataset is a class that creates a dictionary of the type <code>dict[task_name, DataFrame]</code>.
When calling <code>dataset[task_name]</code>, a json file is read, which is converted to a DataFrame.</p><p>Writing to JSONPandasDataset then proceeds as follows. The dataset key is assigned a DataFrame.
Then the DataFrame is converted to json and saved to a file called task in json and md formats.
The comparison takes place using json and the markdown format allows to see the diff for even small changes.</p><p>Then the data is tested using py test.
If there is a non-empty value for the GEN_DATASET variable in the environment variables, the test data generation mode is started.
If GEN_DATASET is empty, then testing is started in the test_task function.
The value of the GEN_DATASET environment variable is defined in the is_gen_dataset_mode function.
Depending on its value, the decorator <code>@pytest.mark.skip if</code> mutually excludes the mode of testing and creating reference data.</p><p>Thus,</p><ul><li>go into the container and run the bash command shell <code>docker-compose exec app bash</code></li><li>enable test data generation mode <code>export GEN_DATASET=any</code></li><li>run pytest <code>pytest tests/dags/test_dummy.py</code> - test data for dataset will be recreated</li><li>turn off the test data generation mode <code>export GEN_DATASET=</code></li><li>run pytest <code>pytest tests/dags/test_dummy.py</code> again - tests will be run</li></ul><p>If PyCharm Professional is used, then the GEN_DATASET value can be registered in the Environment Variables
in the startup configuration and run testing/generation through the application, not the console.</p><p><code>@pytest.mark.parametrize(&#x27;task&#x27;, dag.tasks)</code> - is a decorator that runs a test for each DAG task.</p><p>run_and_assert_task starts only one task. Input datasets for the task are inserted into the function.
Next, a task is launched, transformations are performed, the output dataset is compared with the reference one.</p><p>run_and_gen_ds saves reference data along the transmitted path.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="notes">Notes<a aria-hidden="true" class="hash-link" href="#notes" title="Direct link to heading">​</a></h3><ul><li>DataFrame and other structures in python can contain binary data.
Binary data cannot be stored in JSON. In such cases, it is necessary to use decode/encode or abandon JSONPandasDataset.</li><li>run_and_assert_task uses xor (exclusive or) for comparison and allows not to sort the dataset.</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/tinkoff/data-detective/edit/master/tools/doc-site/docs/data-detective-airflow/testing.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/data-detective-airflow/creating-operator"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« <!-- -->Creating a new operator</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/data-detective-airflow/production"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Production<!-- --> »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#notes" class="table-of-contents__link toc-highlight">Notes</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/logo-tinkoff.svg" alt="" class="themedImage_TMUO themedImage--light_4Vu1 footer__logo"><img src="/img/logo-tinkoff.svg" alt="" class="themedImage_TMUO themedImage--dark_uzRr footer__logo"></div><div class="footer__copyright">Copyright © 2022 tinkoff.ru</div></div></div></footer></div>
<script src="/assets/js/runtime~main.da2280e1.js"></script>
<script src="/assets/js/main.ab52783e.js"></script>
</body>
</html>